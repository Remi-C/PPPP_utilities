---------------------------------------------
--Copyright Remi-C Thales IGN 05/2015
-- 
--this function construct a Bezier curve linking 2 segments
--------------------------------------------

DROP FUNCTION IF EXISTS rc_bezier_from_seg(seg_points geometry, centre_of_intersection geometry, parallel_threshold float, nb_segs int);
CREATE OR REPLACE FUNCTION rc_bezier_from_seg(seg_points geometry,centre_of_intersection geometry, parallel_threshold float, nb_segs int, OUT bezier geometry, OUT pc geometry)
  AS
$BODY$
#this function takes 2 segments, and build a Bezier curve to join the segments
import sys
#sys.path.insert(0, '/media/sf_E_RemiCura/PROJETS/PPPP_utilities/postgis')
sys.path.insert(0, '/media/sf_perso_PROJETS/PPPP_utilities/postgis')
#sys.path.insert(0, '/home/remi')
import rc_py_generate_bezier_curve as rc

reload(rc)
plpy.notice('seg_points : ' + seg_points +' centre_of_intersection ' +centre_of_intersection ) 
tempo = rc.bezier_curve(seg_points, centre_of_intersection, parallel_threshold, nb_segs, in_server=True)
if len(tempo)!=2:
	plpy.notice(tempo)
bezier, pc = tempo

return (bezier,pc)

$BODY$
LANGUAGE plpythonu STABLE STRICT;

SELECT *--, st_astext(bezier), st_astext(pc) 
FROM ST_GeomFromText('MULTIPOINT(0 2,0 1,1 0 ,2 0)') as geom 
	,ST_GeomFromText('POINT(0.5 0.5)') as geom2
	,rc_bezier_from_seg(geom,geom2, 0.85, 10);

	
SELECT geom
FROM ST_GeomFromText('MULTIPOINT(0 2,1 2,2 1 ,2 0)') as geom ; 

SELECT ST_AsText('01020000001F000000000000000000F03F000000000000004061EA72FB830CF13F50D961EA72FBFF3F6687A9CBED0FF23F446587A9CBEDFF3F0BD7A3703D0AF33FD8A3703D0AD7FF3F51D961EA72FBF33F0D951DA62EB7FF3F398EE3388EE3F43FE4388EE3388EFF3FC4F5285C8FC2F53F5E8FC2F5285CFF3FED0F32547698F63F7798BADCFE20FF3FBCDCFE204365F73F34547698BADCFE3F285C8FC2F528F83F8FC2F5285C8FFE3F3A8EE3388EE3F83F90E3388EE338FE3FEA72FB830C95F93F2DB73FC850D9FD3F3E0AD7A3703DFA3F713D0AD7A370FD3F31547698BADCFA3F547698BADCFEFC3FC950D961EA72FB3FDA61EA72FB83FC3F000000000000FC3F000000000000FC3FDA61EA72FB83FC3FC850D961EA72FB3F547698BADCFEFC3F32547698BADCFA3F713D0AD7A370FD3F3E0AD7A3703DFA3F2FB73FC850D9FD3FEA72FB830C95F93F8EE3388EE338FE3F398EE3388EE3F83F90C2F5285C8FFE3F295C8FC2F528F83F32547698BADCFE3FBBDCFE204365F73F7798BADCFE20FF3FEE0F32547698F63F5C8FC2F5285CFF3FC3F5285C8FC2F53FE4388EE3388EFF3F3A8EE3388EE3F43F0C951DA62EB7FF3F52D961EA72FBF33FD7A3703D0AD7FF3F0BD7A3703D0AF33F436587A9CBEDFF3F6687A9CBED0FF23F50D961EA72FBFF3F62EA72FB830CF13F0000000000000040010000000000F03F');  


UPDATE street_amp.visu_result_lane
SET edge_id = edge_id 
WHERE edge_id = 7323 AND lane_ordinality = 2 ;

/*
--SELECT ST_AsText('0102000020AB380E00050000002087BFAEF863B0406DC671653C36D7404801221EC464B04091F0279C9836D740205F1D550767B04036D1756E3137D740BACB32586D6AB04014B3123B1937D740EE316666E66AB0406F0960660637D740')
--SELECT ST_GeomFromText('LINESTRING(4195.97141644525 23768.9436916769
,4196.76608479053 23770.3845310067
,4199.02864249775 23772.772366957
,41200.02864249775 23771.772366957
,4202.4271270511 23772.3942305325
,4202.89999998778 23772.0999984829)')
*/