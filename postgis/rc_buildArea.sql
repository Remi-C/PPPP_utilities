
---------------------------------------------
--Copyright Remi-C Thales IGN 29/11/2013
--
--a wrapper around st_buildarea to take into account polygons with holes, and better deal with isolated linestring
--------------------------------------------


DROP FUNCTION IF EXISTS rc_buildArea(   IN i_geom GEOMETRY, OUT o_geom GEOMETRY );
	  
CREATE OR REPLACE FUNCTION rc_buildArea(   IN i_geom GEOMETRY, OUT o_geom GEOMETRY 
	 ) AS 
	$BODY$
		--@brief : this function takes (multi)polygons and (multi)linestring and build an area over it, removing the inner ring of the polygons
		DECLARE     
		BEGIN 	

			WITH dmp_geom AS (
				SELECT dmp.geom 
				FROM ST_Dump(ST_CollectionExtract(i_geom,3)) as dmp 
			) 
			,ext_ring AS (
				SELECT  rc_ExteriorRing( ST_Union(dmp.geom) )   AS e_r
				FROM dmp_geom  as dmp
				
			)
			,misc_line AS (
				SELECT ST_Union(line.geom) AS line
				FROM   ST_Dump(ST_CollectionExtract(i_geom,2)) AS line
			)
			 ,int_ring AS ( --the coalesce is usefull if there is no interior ring
				SELECT  ST_Union(dmp.geom ) as geom
				FROM dmp_geom , ST_DumpRings(dmp_geom.geom) As dmp
				WHERE dmp.path[1] >0
			)
			,build_area AS (
				SELECT   ST_SetSRID(ST_BuildArea( ST_Union( e_r , line) ) ,ST_SRID(e_r))  AS geom 
				FROM ext_ring, misc_line
			)
			 ,area_with_hole AS (
				SELECT 
					CASE WHEN ir.geom IS NULL THEN
						ba.geom
					ELSE 
						 ST_SymDifference(ba.geom, ir.geom ) 
					END as geom
				FROM build_area as ba LEFT OUTER JOIN int_ring AS ir ON (TRUE)
			)
			SELECT geom INTO o_geom
			FROM area_with_hole  ; 
	RETURN ;
		END ; 
	$BODY$
LANGUAGE plpgsql IMMUTABLE STRICT;    


	
--testing  : 
/*
	WITH the_geom AS (
		SELECT ST_COLLECT(ARRAY[geom1, ST_Translate(geom1, 3,0),line]) as geom
		FROM ST_GeomFromText('POLYGON((0 0, 4 0 , 4 4, 0 4, 0 0),(1 1, 3 1, 3 3, 1 3 , 1 1))') as geom1
			, ST_GeomFromText('LINESTRING (1 3 , 4 6 ,6  3)') as line
	)
	SELECT ST_AsText(rc_buildArea(geom))
	FROM the_geom; 

	 

 
WITH the_geom AS (
		SELECT geom1 AS geom
		FROM ST_GeomFromText(' 
GEOMETRYCOLLECTION(MULTIPOLYGON(((718.852129921982 20439.2112467289,719.172858776063 20439.4451649224,719.533060090844 20439.612017348,719.918891531798 20439.7053919605,720.315525813029 20439.7217004259,720.707720501542 20439.6603160192,721.080403775404 20439.5235977085,721.419253625404 20439.3167995019,721.711248241834 20439.0478685385,721.945166435339 20438.7271396844,722.112018860924 20438.3669383696,722.205393473447 20437.9811069287,722.221701938912 20437.5844726475,722.160317532139 20437.1922779589,722.023599221455 20436.8195946851,721.816801014866 20436.4807448351,721.547870051478 20436.1887502187,717.847870051532 20432.8887502202,717.527141197451 20432.6548320267,717.166939882671 20432.4879796011,716.781108441716 20432.3946049886,716.384474160486 20432.3782965231,715.992279471972 20432.4396809299,715.61959619811 20432.5763992406,715.280746348111 20432.7831974472,714.98875173168 20433.0521284106,714.754833538175 20433.3728572646,714.58798111259 20433.7330585794,714.494606500067 20434.1188900204,714.478298034602 20434.5155243016,714.539682441375 20434.9077189901,714.67640075206 20435.280402264,714.883198958648 20435.619252114,715.152129922036 20435.9112467304,718.852129921982 20439.2112467289)),((721.3708460284 20436.0478046151,721.026021518093 20435.8511303255,720.649453463574 20435.725507002,720.255613163996 20435.6757622784,719.859635681203 20435.7038078167,719.476738207794 20435.8085658424,719.12163527894 20435.9860105634,718.807973301051 20436.2293228785,718.547806128036 20436.5291524321,718.35113183845 20436.8739769424,718.225508514945 20437.2505449969,718.175763791393 20437.6443852965,718.203809329623 20438.0403627793,718.308567355328 20438.4232602527,718.486012076332 20438.7783631816,718.729324391516 20439.0920251594,719.02915394506 20439.3521923325,722.778687713561 20442.0093422473,723.123512223869 20442.2060165369,723.500080278388 20442.3316398604,723.893920577966 20442.381384584,724.289898060758 20442.3533390457,724.672795534167 20442.24858102,725.027898463022 20442.071136299,725.34156044091 20441.8278239838,725.601727613925 20441.5279944303,725.798401903512 20441.18316992,725.924025227017 20440.8066018655,725.973769950569 20440.4127615659,725.945724412339 20440.0167840831,725.840966386633 20439.6338866097,725.66352166563 20439.2787836808,725.420209350446 20438.9651217029,725.120379796902 20438.7049545299,721.3708460284 20436.0478046151)),((718.455148565169 20436.6723222034,718.288185701458 20437.0324723405,718.194692788572 20437.4182751325,718.178262706722 20437.8149043945,718.23952685474 20438.2071178865,718.376130885774 20438.5798430638,718.58282518352 20438.9187563069,718.851666602031 20439.21083337,719.172323716362 20439.4448498953,719.532473853436 20439.611812759,719.91827664546 20439.7053056719,720.314905907496 20439.7217357538,720.707119399437 20439.6604716057,721.079844576744 20439.5238675747,721.418757819879 20439.317173277,721.710834882973 20439.0483318585,721.944851408291 20438.7276747441,724.965627546685 20433.5988168622,725.132590410396 20433.2386667252,725.226083323282 20432.8528639332,725.242513405132 20432.4562346711,725.181249257114 20432.0640211792,725.044645226081 20431.6912960019,724.837950928335 20431.3523827587,724.569109509823 20431.0603056956,724.248452395492 20430.8262891703,723.888302258418 20430.6593263066,723.502499466394 20430.5658333937,723.105870204358 20430.5494033119,722.713656712417 20430.6106674599,722.34093153511 20430.7472714909,722.002018291975 20430.9539657887,721.709941228881 20431.2228072072,721.475924703563 20431.5434643215,718.455148565169 20436.6723222034))),MULTILINESTRING((721.186691744178 20435.900117013,721.733062185778 20436.335134308),(725.105924907499 20438.725351985,724.661732976323 20438.3399191361,724.301270287161 20437.8752347244,724.038389219008 20437.3491563113,723.883192143887 20436.7819007951,723.84164319836 20436.1952674873,723.915339085102 20435.6118003768,724.101447712516 20435.0539217775,724.255546566919 20434.755174016),(721.497466079138 20431.5561516829,721.142890260993 20432.0359862681,720.701516434029 20432.4374266557,720.190306346892 20432.7450457168,719.62890551654 20432.9470218235,719.038888262046 20433.035593147,718.442928615616 20433.0073559413,717.863928972242 20432.8633953462,717.378092818984 20432.6407078052))) ') as geom1 
	)
 
	--WITH the_geom AS (
	--	SELECT ST_COLLECT(ARRAY[geom1, ST_Translate(geom1, 3,0),line]) as geom
	--	FROM ST_GeomFromText('POLYGON((0 0, 4 0 , 4 4, 0 4, 0 0),(1 1, 3 1, 3 3, 1 3 , 1 1))') as geom1
	--		, ST_GeomFromText('LINESTRING (1 3 , 4 6 ,6  3)') as line
	--)
	  SELECT ST_AsText(rc_buildArea(geom))
	  FROM the_geom; 
	 ,dmp_geom AS (
		SELECT dmp.geom 
		FROM the_geom, ST_Dump(ST_CollectionExtract(geom,3)) as dmp
	)
	,ext_ring AS (
		SELECT  ST_ExteriorRing(ST_Union(dmp.geom))   AS e_r 
		FROM dmp_geom  as dmp
	)
	,misc_line AS (
		SELECT ST_Union(line.geom) AS line
		FROM the_geom  ,  ST_Dump(ST_CollectionExtract(geom,2)) AS line
	)
	 ,int_ring AS ( --the coalesce is usefull if there is no interior ring
		SELECT  ST_Union(dmp.geom)  as geom
		FROM dmp_geom , ST_DumpRings(dmp_geom.geom) As dmp
		WHERE dmp.path[1] >0
	)
	,build_area AS (
		SELECT   ST_SetSRID(ST_BuildArea( ST_Union( e_r , line) ) ,ST_SRID(e_r))  AS geom 
		FROM ext_ring, misc_line
	)
	 ,area_with_hole AS (
		SELECT 
			CASE WHEN ir.geom IS NULL THEN
				ba.geom
			ELSE 
				 ST_SymDifference(ba.geom, ir.geom ) 
			END as geom
		FROM build_area as ba LEFT OUTER JOIN int_ring AS ir ON (TRUE)
	)
	SELECT ST_AsText(geom)
	FROM area_with_hole ;

	

	WITH the_geom AS (
	SELECT ST_COLLECT(ARRAY[geom1, ST_Translate(geom1, 3,0),line]) as geom
	FROM ST_GeomFromText('POLYGON((0 0, 4 0 , 4 4, 0 4, 0 0),(1 1, 3 1, 3 3, 1 3 , 1 1))') as geom1
		, ST_GeomFromText('LINESTRING (1 3 , 4 6 ,6  3)') as line
	)
	SELECT ST_AsText(ST_SymDifference(geom ,ST_GeomFromText('LINESTRING EMPTY')))
	FROM the_geom 
	*/
